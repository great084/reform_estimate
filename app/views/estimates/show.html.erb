
顧客名：<%= @estimate.customer_name %>様 <br />
見積内容：<%= @estimate.subject %> <br />
小計：<%= @estimate.subtotal %> <br />
消費税：<%= @estimate.consumption_tax %> <br />
総計：<%= @estimate.grand_total %> <br />

<h2>カテゴリー
</h2>
<% if @estimate_categories && @active_category %>
  <ul id="categoriesTabs" class="nav nav-tabs justify-content-center">
    <% @estimate_categories.each_with_index do |ec, i| %>
      <%# binding.pry %>
      <% if ec == @active_category %>
        <li role="presentation" class="active">
          <%= link_to estimate_path(@estimate, estimate_category_id: ec.id) do %>
            <button aria-controls="spot-tab" role="tab" class="nav-link active"><%= ec.name %></button>
          <% end %>
        </li>
      <% else %>
        <li role="presentation">
          <%= link_to estimate_path(@estimate, estimate_category_id: ec.id)  do %>
            <button aria-controls="spot-tab" role="tab" class="nav-link "><%= ec.name %></button>
          <% end %>
        </li>
      <% end %>
    <% end %>
  </ul>
<% end %>

<div class="row">
      <div class="col-2">商品名</div>
      <div class="col-2">仕様</div>
      <div class="col-1">単位</div>
      <div class="col-1">単価</div>
      <div class="col-1">数量</div>
      <div class="col-1">金額</div>
      <div class="col-2">備考</div>
      <div class="col-2">操作</div>
</div>

<% if @estimate_details %>
<% @estimate_details.each do |ed| %>
  <%= form_for(ed, url: estimate_detail_path(ed), method: :put) do |f| %>
    <div class="form-row">
        <%#= f.hidden_field :id %>
        <div class="form-group col-2">
          <%= f.text_field :item_name ,id: 'inputItemName', class: 'form-control'%>
        </div>
        <div class="form-group col-2">
          <%= f.text_field :specification, id: 'inputSpecification', class: 'form-control' %>
        </div>
        <div class="form-group col-1">
          <%= f.text_field :unit, class: 'form-control' %>
        </div>
        <div class="form-group col-1">
          <%= f.number_field :unit_price, class: 'form-control' %>
        </div>
        <div class="form-group col-2">
          <%= f.text_field :remark, class: 'form-control' %>
        </div>
        <div class="form-group col-1">
          <%= f.submit '更新',  class: ' btn btn-primary btn-block ' %>
        </div>
        <div class="form-group col-1">
          <%= link_to '削除', estimate_detail_path(ed), method: :delete, class: 'btn btn-secondary btn-block ' %>
        </div>
    </div>
  <% end %>
<% end %>
<% end %>


  <%= form_for(@estimate_detail, url: estimate_details_path, method: :post) do |f| %>
    <div class="form-row">
        <%= f.hidden_field :estimate_category_id, value: @active_category.id %>
        <div class="form-group col-4">
          <%= f.collection_select :price_table_id, selectable_price_tables(@active_category.category), :id, :full_item_name , {}, class: 'form-control', id: 'item-selection', :onchange => "getDetails($(this).val())" %>
        </div>
        <div class="form-group">
          <%= f.hidden_field :specification, id: 'inputSpecification specification-selection', class: 'form-control' %>
        </div>
        <div class="form-group col-1">
          <%= f.text_field :unit, id: 'inputUnit', class: 'form-control', required: true %>
        </div>
        <div class="form-group col-1">
          <%= f.number_field :unit_price, id: 'inputUnitPrice', class: 'form-control', required: true %>
        </div>
        <div class="form-group col-1">
          <%= f.number_field :quantity, id: 'inputQuantity', class: 'form-control', required: true  %>
        </div>
        <div class="form-group col-1">
          <%= f.number_field :price, id: 'inputPrice', class: 'form-control', readonly: true %>
        </div>
        <div class="form-group col-2">
          <%= f.text_field :remark, id: 'inputRemark', class: 'form-control' %>
        </div>
        <div class="form-group col-2">
          <%= f.submit '新規登録',  class: ' btn btn-success btn-block' %>
        </div>
    </div>
  <% end %>

<% if @estimate_details %>
<%# render partial: 'estimate_details/form', collection: @estimate_details, as: 'estimate_detail' %> 
<% @estimate_details.each do |ed|  %>
  <%= ed.id %>
  <%= ed.estimate_category_id %>
  <%=  ed.item_name %>
  <%=  ed.specification  %>
  <%= ed.unit  %>
  <%= ed.unit_price  %>
  <%= ed.quantity %>
  <%= ed.price %>
  <br>
<% end %>
<% end %>

<script>
  function getDetails(val){
    var price_table_id = val;

    $.ajax({
      url: "estimate_details/get_details",
      type: "GET",
      data: {
        price_table_id: price_table_id
      }
    })
  }
</script>